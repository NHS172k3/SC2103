<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 2: Memory Primitives + Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .option-btn {
        transition: all 0.2s ease;
      }
      .option-btn:hover:not(:disabled) {
        transform: translateX(4px);
      }
      .loader {
        border-top-color: #6366f1;
        animation: spinner 1.5s linear infinite;
      }
      @keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen pb-12">
    <div id="app" class="max-w-4xl mx-auto px-4 pt-8">
      <!-- User Info Bar -->
      <div class="mb-4 flex justify-end" id="user-info">
        <!-- User info will be inserted here by JavaScript -->
      </div>

      <!-- Header -->
      <header class="mb-8 text-center">
        <h1 class="text-3xl font-extrabold text-slate-900 mb-2">
          Lab 2 Quiz Practice
        </h1>
        <p class="text-slate-600">Memory Primitives & FPGA Implementation</p>
        <p class="text-xs text-slate-400 mt-2">
          üí° Tip: Use keyboard shortcuts (1-4) to select answers!
        </p>
      </header>

      <!-- Menu / Dashboard -->
      <div
        id="setup-screen"
        class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8"
      >
        <h2 class="text-xl font-bold mb-4">Select Study Mode</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
          <button
            onclick="startQuiz('all')"
            class="p-4 text-left border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-colors group"
          >
            <div class="font-bold text-indigo-600">Full Practice</div>
            <div class="text-sm text-slate-500">
              All 100 questions across all categories
            </div>
          </button>
          <button
            onclick="showCategorySelector()"
            class="p-4 text-left border-2 border-emerald-100 rounded-xl hover:border-emerald-500 hover:bg-emerald-50 transition-colors"
          >
            <div class="font-bold text-emerald-600">Targeted Practice</div>
            <div class="text-sm text-slate-500">
              Focus on a specific section
            </div>
          </button>
        </div>

        <div
          id="category-list"
          class="hidden space-y-2 animate-in fade-in duration-300"
        >
          <h3 class="font-semibold text-slate-700 mb-3">Pick a Section:</h3>
          <div
            class="grid grid-cols-1 sm:grid-cols-2 gap-2"
            id="category-buttons"
          ></div>
        </div>

        <div class="mt-8 pt-6 border-t border-slate-100">
          <button
            onclick="showLeaderboardOnly()"
            class="text-indigo-600 font-semibold hover:underline flex items-center justify-center w-full"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              ></path>
            </svg>
            View Global Leaderboard
          </button>
        </div>
      </div>

      <!-- Quiz Interface -->
      <div id="quiz-screen" class="hidden space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
          <div class="flex justify-between items-center mb-2">
            <span
              id="category-label"
              class="text-xs font-bold uppercase tracking-wider text-indigo-500"
              >Section A</span
            >
            <span id="progress-text" class="text-xs font-medium text-slate-500"
              >Question 1 of 100</span
            >
          </div>
          <div class="w-full bg-slate-100 rounded-full h-2">
            <div
              id="progress-bar"
              class="bg-indigo-500 h-2 rounded-full transition-all duration-300"
              style="width: 1%"
            ></div>
          </div>
        </div>

        <div
          class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden"
        >
          <div class="p-6 md:p-8 bg-slate-50 border-b border-slate-200">
            <div
              id="question-text"
              class="text-lg md:text-xl font-semibold text-slate-800 leading-relaxed"
            ></div>
            <div
              id="code-block"
              class="hidden mt-4 p-4 bg-slate-900 rounded-lg text-emerald-400 font-mono text-sm whitespace-pre overflow-x-auto"
            ></div>
          </div>
          <div id="options-container" class="p-6 md:p-8 space-y-3"></div>
        </div>

        <div class="flex justify-between items-center px-2">
          <button
            onclick="exitQuiz()"
            class="text-slate-400 hover:text-slate-600 font-medium text-sm"
          >
            Exit Quiz
          </button>
          <button
            id="next-btn"
            onclick="nextQuestion()"
            disabled
            class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 disabled:opacity-50 hover:bg-indigo-700 transition-all"
          >
            Next Question
          </button>
        </div>
      </div>

      <!-- Results Screen -->
      <div
        id="results-screen"
        class="hidden text-center animate-in fade-in duration-500"
      >
        <div
          class="bg-white rounded-2xl shadow-xl border border-slate-200 p-8 mb-6"
        >
          <h2 class="text-3xl font-extrabold text-slate-900 mb-2">
            Quiz Complete!
          </h2>
          <p id="result-meta" class="text-slate-500 mb-8 font-medium"></p>

          <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto mb-10">
            <div class="p-4 bg-slate-50 rounded-xl">
              <div id="final-score" class="text-3xl font-bold text-indigo-600">
                0
              </div>
              <div class="text-xs font-bold text-slate-400 uppercase">
                Score
              </div>
            </div>
            <div id="save-score-section">
              <div class="p-4 bg-slate-50 rounded-xl">
                <div
                  id="final-percent"
                  class="text-3xl font-bold text-emerald-600"
                >
                  0%
                </div>
                <div class="text-xs font-bold text-slate-400 uppercase">
                  Accuracy
                </div>
              </div>
            </div>
          </div>

          <!-- Submit to Leaderboard -->
          <div
            id="submit-form"
            class="max-w-sm mx-auto p-6 bg-indigo-50 rounded-2xl border border-indigo-100"
          >
            <!-- Will be populated by showResults() -->
          </div>
        </div>

        <button
          onclick="location.reload()"
          class="px-10 py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all"
        >
          Back to Home
        </button>
      </div>

      <!-- Leaderboard Screen -->
      <div
        id="leaderboard-screen"
        class="hidden space-y-6 animate-in slide-in-from-bottom-4 duration-500"
      >
        <div
          class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden"
        >
          <div
            class="bg-indigo-600 p-6 text-white flex justify-between items-center"
          >
            <h2 class="text-2xl font-bold">Global Leaderboard</h2>
            <button
              onclick="exitQuiz()"
              class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l18 18"
                ></path>
              </svg>
            </button>
          </div>
          <div class="p-2">
            <table class="w-full">
              <thead>
                <tr
                  class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100"
                >
                  <th class="px-6 py-4 text-left">Rank</th>
                  <th class="px-6 py-4 text-left">User</th>
                  <th class="px-6 py-4 text-right">Score</th>
                </tr>
              </thead>
              <tbody id="leaderboard-body" class="divide-y divide-slate-50">
                <!-- Scores here -->
              </tbody>
            </table>
            <div
              id="leaderboard-loading"
              class="p-12 flex flex-col items-center justify-center text-slate-400"
            >
              <div
                class="loader w-8 h-8 border-4 border-slate-200 rounded-full mb-4"
              ></div>
              <p>Loading scores...</p>
            </div>
          </div>
        </div>
        <button
          onclick="location.reload()"
          class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold"
        >
          Play Again
        </button>
      </div>
    </div>

    <!-- Firebase Configuration (loaded from external file) -->
    <script src="firebase-config.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        limit,
        doc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Firebase config is loaded from firebase-config.js
      // This file is in .gitignore to keep your credentials private

      let app,
        auth,
        db,
        user = null;
      const provider = new GoogleAuthProvider();

      // Initialize Firebase with error handling
      try {
        if (typeof firebaseConfig === "undefined") {
          throw new Error(
            "firebaseConfig not loaded. Check if firebase-config.js exists.",
          );
        }

        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        console.log("‚úì Firebase initialized successfully");
        console.log("Project ID:", firebaseConfig.projectId);

        onAuthStateChanged(auth, (u) => {
          user = u;
          if (u) {
            console.log("‚úì Signed in as:", u.displayName || u.email);
            updateUserUI(u);
          } else {
            console.log("‚óã Not signed in");
            updateUserUI(null);
          }
        });
      } catch (e) {
        console.error("Firebase initialization failed:", e);
        console.error("Error details:", e.message);
        showError("Leaderboard unavailable. Quiz still works!");

        // Make auth/db null so other checks work
        auth = null;
        db = null;
      }

      function updateUserUI(user) {
        const userInfo = document.getElementById("user-info");
        if (!userInfo) return;

        if (user) {
          userInfo.innerHTML = `
            <div class="flex items-center gap-3">
              ${user.photoURL ? `<img src="${user.photoURL}" class="w-8 h-8 rounded-full" alt="${user.displayName}">` : ""}
              <span class="text-sm font-medium text-slate-700">${user.displayName || user.email}</span>
              <button onclick="signOutUser()" class="text-xs text-slate-500 hover:text-slate-700 underline">Sign Out</button>
            </div>
          `;
        } else {
          userInfo.innerHTML = `
            <button onclick="signInWithGoogle()" class="flex items-center gap-2 px-4 py-2 bg-white border-2 border-slate-200 rounded-lg hover:border-indigo-500 transition-all text-sm font-medium text-slate-700">
              <svg class="w-5 h-5" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Sign in with Google
            </button>
          `;
        }
      }

      window.signInWithGoogle = async () => {
        if (!auth) {
          alert(
            "Firebase not initialized. Check firebase-config.js and browser console.",
          );
          return;
        }

        try {
          const result = await signInWithPopup(auth, provider);
          user = result.user;
          console.log("‚úì Signed in as:", user.displayName);
        } catch (error) {
          console.error("Sign-in error:", error);
          console.error("Error code:", error.code);
          console.error("Error message:", error.message);

          if (error.code === "auth/popup-closed-by-user") {
            alert(
              "Sign-in cancelled. You can still use the quiz without leaderboard features.",
            );
          } else if (error.code === "auth/popup-blocked") {
            alert(
              "Pop-up blocked by browser. Please allow pop-ups for this site and try again.",
            );
          } else if (error.code === "auth/unauthorized-domain") {
            alert(
              "This domain is not authorized. Add it in Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains.",
            );
          } else {
            alert(
              `Sign-in failed: ${error.message}\n\nCheck console for details. You can still use the quiz without leaderboard.`,
            );
          }
        }
      };

      window.signOutUser = async () => {
        if (!auth) {
          console.error("Firebase auth not initialized");
          return;
        }

        try {
          await signOut(auth);
          console.log("‚úì Signed out");
          user = null;
        } catch (error) {
          console.error("Sign-out error:", error);
          alert("Sign-out failed. Please refresh the page.");
        }
      };

      function showError(msg) {
        const banner = document.createElement("div");
        banner.className =
          "bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded";
        banner.innerHTML = `<p class="font-semibold">‚ö†Ô∏è ${msg}</p>`;
        document.getElementById("app").prepend(banner);
      }

      // Quiz Logic - ALL 100 QUESTIONS
      const quizData = [
        // Section A: Memory Architecture (15 questions)
        {
          id: 1,
          category: "Section A: Memory Architecture",
          q: "What type of memory is used in Lab 2?",
          options: [
            "Block RAM (BRAM)",
            "Distributed RAM (LUT-based)",
            "Flash memory",
            "DRAM",
          ],
          a: 1,
        },
        {
          id: 2,
          category: "Section A: Memory Architecture",
          q: "Why is distributed RAM preferred over Block RAM for this lab?",
          options: [
            "Distributed RAM is faster",
            "The memory size (512 bits) is too small to efficiently use BRAM",
            "Block RAM doesn't exist on Artix-7 FPGAs",
            "Distributed RAM has built-in reset functionality",
          ],
          a: 1,
        },
        {
          id: 3,
          category: "Section A: Memory Architecture",
          q: "How many LUTs are required to implement a 64√ó8 distributed RAM?",
          options: ["1 LUT", "8 LUTs", "64 LUTs", "512 LUTs"],
          a: 1,
        },
        {
          id: 4,
          category: "Section A: Memory Architecture",
          q: "Why is the memory depth set to 64 in this lab?",
          options: [
            "It's the maximum depth supported",
            "It matches perfectly with a 6-input LUT architecture (2^6 = 64)",
            "64 is the standard depth for all FPGAs",
            "It's required by the Basys 3 board",
          ],
          a: 1,
        },
        {
          id: 5,
          category: "Section A: Memory Architecture",
          q: "What does each LUT in the distributed RAM store?",
          options: [
            "All 64 addresses",
            "One bit across all 64 addresses",
            "One complete 8-bit word",
            "The control logic",
          ],
          a: 1,
        },
        {
          id: 6,
          category: "Section A: Memory Architecture",
          q: "The memory address port is 6 bits wide because:",
          options: [
            "We only have 6 switches available",
            "2^6 = 64, matching the memory depth",
            "The FPGA requires 6-bit addresses",
            "It's a standard in Verilog",
          ],
          a: 1,
        },
        {
          id: 7,
          category: "Section A: Memory Architecture",
          q: "What happens to d_in[7:6] when addressing memory?",
          options: [
            "They are used for error checking",
            "They control the write enable",
            "They are ignored (only d_in[5:0] is used for address)",
            "They select the memory bank",
          ],
          a: 2,
        },
        {
          id: 8,
          category: "Section A: Memory Architecture",
          q: "Which statement about the memory's read operation is TRUE?",
          options: [
            "Reads are synchronous (require clock edge)",
            "Reads are asynchronous (combinational, immediate)",
            "Reads require a read enable signal",
            "Reads take 2 clock cycles",
          ],
          a: 1,
        },
        {
          id: 9,
          category: "Section A: Memory Architecture",
          q: "Which statement about the memory's write operation is TRUE?",
          options: [
            "Writes are asynchronous",
            "Writes occur immediately when data changes",
            "Writes are synchronous (occur on clock edge when write_en=1)",
            "Writes don't require a clock",
          ],
          a: 2,
        },
        {
          id: 10,
          category: "Section A: Memory Architecture",
          q: "Can distributed RAM be initialized with data at synthesis time?",
          options: [
            "Yes, always",
            "No, never",
            "Yes, but it's typically not done; Block RAM is better for initialization",
            "Only on certain FPGA families",
          ],
          a: 2,
        },
        {
          id: 11,
          category: "Section A: Memory Architecture",
          q: "In the IP Configuration, why are inputs/outputs set as 'unregistered'?",
          options: [
            "To save power",
            "To allow asynchronous reads and keep the design simple",
            "Because the FPGA doesn't have enough registers",
            "It's a requirement for distributed RAM",
          ],
          a: 1,
        },
        {
          id: 12,
          category: "Section A: Memory Architecture",
          q: "What would happen if we used a depth of 128 instead of 64?",
          options: [
            "It would fail to synthesize",
            "It would require 2 LUTs per bit plus multiplexers, doubling resources",
            "It would be more efficient",
            "Nothing would change",
          ],
          a: 1,
        },
        {
          id: 13,
          category: "Section A: Memory Architecture",
          q: "The memory output port 'spo' stands for:",
          options: [
            "Special Purpose Output",
            "Single Port Output",
            "Synchronous Pipelined Output",
            "Serial Port Output",
          ],
          a: 1,
        },
        {
          id: 14,
          category: "Section A: Memory Architecture",
          q: "Which memory type typically has synchronous reads?",
          options: ["Distributed RAM", "Block RAM", "Both", "Neither"],
          a: 1,
        },
        {
          id: 15,
          category: "Section A: Memory Architecture",
          q: "The total memory capacity in this lab is:",
          options: ["64 bits", "512 bits (64 √ó 8)", "8 bits", "1 Kbit"],
          a: 1,
        },

        // Section B: Design Architecture (15 questions)
        {
          id: 16,
          category: "Section B: Design Architecture",
          q: "What is the purpose of the register (reg_d) in this design?",
          options: [
            "To store the memory output",
            "To act as a staging area for data before writing to memory",
            "To clock the system",
            "To display data on the 7-segment display",
          ],
          a: 1,
        },
        {
          id: 17,
          category: "Section B: Design Architecture",
          q: "Why does the RAM's data input connect to reg_d instead of d_in?",
          options: [
            "It's a mistake in the design",
            "To allow time-multiplexing: save data to register, then change switches to address",
            "reg_d is faster than d_in",
            "The IP core requires it",
          ],
          a: 1,
        },
        {
          id: 18,
          category: "Section B: Design Architecture",
          q: "What is the correct two-step process to write to memory?",
          options: [
            "Set address, press write_en",
            "Set data, press write_en",
            "Set data and press save_data, then set address and press write_en",
            "Press write_en, then set data",
          ],
          a: 2,
        },
        {
          id: 19,
          category: "Section B: Design Architecture",
          q: "The multiplexer (MUX) in the design:",
          options: [
            "Selects between clock sources",
            "Selects between displaying register contents or memory contents",
            "Selects which memory address to read",
            "Selects between different data inputs",
          ],
          a: 1,
        },
        {
          id: 20,
          category: "Section B: Design Architecture",
          q: "When show_reg = 1, d_out displays:",
          options: [
            "The register contents (reg_d)",
            "The memory contents (mem_d)",
            "The input switches (d_in)",
            "Zero",
          ],
          a: 1,
        },
        {
          id: 21,
          category: "Section B: Design Architecture",
          q: "When show_reg = 0, d_out displays:",
          options: [
            "The register contents (reg_d)",
            "The memory contents (mem_d)",
            "The input switches (d_in)",
            "The previous value",
          ],
          a: 0,
        },
        {
          id: 22,
          category: "Section B: Design Architecture",
          q: "The naming of 'show_reg' can be confusing because:",
          options: [
            "When it's 1, it shows memory, not register",
            "When it's 0, it shows register (the default state)",
            "Both A and B",
            "Neither A nor B",
          ],
          a: 2,
        },
        {
          id: 23,
          category: "Section B: Design Architecture",
          q: "What architectural pattern does the register usage represent?",
          options: [
            "State machine",
            "Load-store architecture / staging area",
            "Pipeline",
            "Cache memory",
          ],
          a: 1,
        },
        {
          id: 24,
          category: "Section B: Design Architecture",
          q: "How many internal signals are declared in Lab2_top?",
          options: ["None", "One (mem_d)", "Two (reg_d and mem_d)", "Three"],
          a: 2,
        },
        {
          id: 25,
          category: "Section B: Design Architecture",
          q: "Why is reg_d declared as 'reg' type?",
          options: [
            "It will be a physical register",
            "It's assigned inside an 'always' block",
            "It needs to be fast",
            "Verilog requires it for 8-bit signals",
          ],
          a: 1,
        },
        {
          id: 26,
          category: "Section B: Design Architecture",
          q: "Why is mem_d declared as 'wire' type?",
          options: [
            "It's driven by the RAM IP output",
            "It changes frequently",
            "It's faster than 'reg'",
            "It's an input",
          ],
          a: 0,
        },
        {
          id: 27,
          category: "Section B: Design Architecture",
          q: "The reset signal in this design is:",
          options: [
            "Asynchronous (immediate)",
            "Synchronous (occurs on clock edge)",
            "Not needed",
            "Active low",
          ],
          a: 1,
        },
        {
          id: 28,
          category: "Section B: Design Architecture",
          q: "What does the reset do?",
          options: [
            "Clears the memory",
            "Clears reg_d to 0",
            "Resets both memory and register",
            "Resets the entire FPGA",
          ],
          a: 1,
        },
        {
          id: 29,
          category: "Section B: Design Architecture",
          q: "The design pattern of using d_in for both data and address is called:",
          options: [
            "Multiplexing",
            "Time-division multiplexing",
            "Demultiplexing",
            "Address/data bus sharing",
          ],
          a: 1,
        },
        {
          id: 30,
          category: "Section B: Design Architecture",
          q: "In the always block, why do we use <= instead of =?",
          options: [
            "It's faster",
            "Non-blocking assignment is required for sequential (clocked) logic",
            "Blocking assignment would cause errors",
            "Both B and C",
          ],
          a: 3,
        },

        // Section C: Clock Management (10 questions)
        {
          id: 31,
          category: "Section C: Clock Management",
          q: "What is the frequency of the Basys 3 system clock?",
          options: ["10 MHz", "50 MHz", "100 MHz", "1 GHz"],
          a: 2,
        },
        {
          id: 32,
          category: "Section C: Clock Management",
          q: "Why can't we use the 100 MHz clock directly for button inputs?",
          options: [
            "It's too slow",
            "A button press (~100ms) would span 10 million clock cycles",
            "The FPGA can't handle it",
            "It would damage the hardware",
          ],
          a: 1,
        },
        {
          id: 33,
          category: "Section C: Clock Management",
          q: "The clock divider (clkgen) divides the clock by:",
          options: ["2^8", "2^16", "2^28", "2^32"],
          a: 2,
        },
        {
          id: 34,
          category: "Section C: Clock Management",
          q: "What is the approximate frequency of the slow clock (sClk)?",
          options: ["~0.37 Hz", "~10 Hz", "~1 kHz", "~50 MHz"],
          a: 0,
        },
        {
          id: 35,
          category: "Section C: Clock Management",
          q: "The period of the slow clock is approximately:",
          options: ["10 ns", "100 ms", "~2.68 seconds", "10 seconds"],
          a: 2,
        },
        {
          id: 36,
          category: "Section C: Clock Management",
          q: "How does the clock divider work?",
          options: [
            "Using a PLL",
            "Using a 28-bit counter; output is the MSB which toggles every 2^27 cycles",
            "Using multiple flip-flops in series",
            "Using the FPGA's built-in clock divider",
          ],
          a: 1,
        },
        {
          id: 37,
          category: "Section C: Clock Management",
          q: "Why is LED[7] connected to sClk?",
          options: [
            "To show the system is powered",
            "To provide visual feedback of when clock edges occur",
            "To indicate errors",
            "To show the reset state",
          ],
          a: 1,
        },
        {
          id: 38,
          category: "Section C: Clock Management",
          q: "When operating the FPGA, you should press a button:",
          options: [
            "Quickly and release",
            "Hold until LED[7] blinks, then release",
            "Hold for exactly 1 second",
            "Press multiple times rapidly",
          ],
          a: 1,
        },
        {
          id: 39,
          category: "Section C: Clock Management",
          q: "What is the time scale difference between human button press and FPGA clock?",
          options: [
            "1,000√ó (3 orders of magnitude)",
            "1,000,000√ó (6 orders of magnitude)",
            "10,000,000√ó (7 orders of magnitude)",
            "1,000,000,000√ó (9 orders of magnitude)",
          ],
          a: 2,
        },
        {
          id: 40,
          category: "Section C: Clock Management",
          q: "Which clock is used in Lab2_top when integrated into Lab2_imp?",
          options: [
            "clk (100 MHz)",
            "sClk (slow clock)",
            "An external clock",
            "No clock",
          ],
          a: 1,
        },

        // Section D: Testbench and Simulation (10 questions)
        {
          id: 41,
          category: "Section D: Testbench and Simulation",
          q: "In a testbench, inputs to the UUT (Unit Under Test) are declared as:",
          options: ["wire", "reg", "integer", "parameter"],
          a: 1,
        },
        {
          id: 42,
          category: "Section D: Testbench and Simulation",
          q: "In a testbench, outputs from the UUT are declared as:",
          options: ["wire", "reg", "integer", "parameter"],
          a: 0,
        },
        {
          id: 43,
          category: "Section D: Testbench and Simulation",
          q: "The timescale `1ns / 1ps` means:",
          options: [
            "Time unit = 1ns, precision = 1ps",
            "Time unit = 1ps, precision = 1ns",
            "Simulation runs at 1ns per second",
            "Delays are in picoseconds",
          ],
          a: 0,
        },
        {
          id: 44,
          category: "Section D: Testbench and Simulation",
          q: "To create a 100 MHz clock in simulation, the clock should toggle every:",
          options: ["5 ns", "10 ns", "100 ns", "1 Œºs"],
          a: 0,
        },
        {
          id: 45,
          category: "Section D: Testbench and Simulation",
          q: "The expected output sequence in the testbench is:",
          options: [
            "0, 15, A3, 87, 15, 87",
            "15, A3, 87, 15, 87, 0",
            "0, 0, 15, A3, 87, 15",
            "87, A3, 15, 0, 0, 0",
          ],
          a: 0,
        },
        {
          id: 46,
          category: "Section D: Testbench and Simulation",
          q: "Why do we need to add reg_d and mem_d to the waveform?",
          options: [
            "It's required by Vivado",
            "To see internal signals for debugging",
            "To make the simulation faster",
            "They are outputs",
          ],
          a: 1,
        },
        {
          id: 47,
          category: "Section D: Testbench and Simulation",
          q: "When should you close the simulator window?",
          options: [
            "Immediately after simulation completes",
            "After verifying the output",
            "Never during the lab session (needed for assessment)",
            "After Task 3",
          ],
          a: 2,
        },
        {
          id: 48,
          category: "Section D: Testbench and Simulation",
          q: "The $finish() command:",
          options: [
            "Pauses the simulation",
            "Stops the simulation",
            "Restarts the simulation",
            "Saves the waveform",
          ],
          a: 1,
        },
        {
          id: 49,
          category: "Section D: Testbench and Simulation",
          q: "In the test sequence, when is Memory[1] written?",
          options: [
            "At time 40ns",
            "At time 50ns (when write_en=1, address=0x01, reg_d=0x15)",
            "At time 60ns",
            "Never",
          ],
          a: 1,
        },
        {
          id: 50,
          category: "Section D: Testbench and Simulation",
          q: "What value is in Memory[2] after the test sequence?",
          options: ["0x15", "0xA3", "0x87", "Undefined"],
          a: 1,
        },

        // Section E: FPGA Implementation (10 questions)
        {
          id: 51,
          category: "Section E: FPGA Implementation",
          q: "What is the purpose of the Lab2_imp.v wrapper?",
          options: [
            "To test the design",
            "To add FPGA-specific modules (clock divider, 7-segment driver)",
            "To replace Lab2_top",
            "To generate the bitstream",
          ],
          a: 1,
        },
        {
          id: 52,
          category: "Section E: FPGA Implementation",
          q: "Which module displays data on the 7-segment display?",
          options: ["clkgen", "seven_seg", "Lab2_top", "Lab2_mem"],
          a: 1,
        },
        {
          id: 53,
          category: "Section E: FPGA Implementation",
          q: "The XDC file is used to:",
          options: [
            "Configure the memory",
            "Map signals to physical FPGA pins",
            "Set up the clock",
            "Define module parameters",
          ],
          a: 1,
        },
        {
          id: 54,
          category: "Section E: FPGA Implementation",
          q: "LVCMOS33 means:",
          options: [
            "33 MHz clock",
            "3.3V low-voltage CMOS logic standard",
            "33 logic cells",
            "33-pin package",
          ],
          a: 1,
        },
        {
          id: 55,
          category: "Section E: FPGA Implementation",
          q: "The three stages of FPGA build process are:",
          options: [
            "Compile, Link, Load",
            "Synthesize, Implement, Generate Bitstream",
            "Design, Simulate, Program",
            "Edit, Build, Deploy",
          ],
          a: 1,
        },
        {
          id: 56,
          category: "Section E: FPGA Implementation",
          q: "What does synthesis do?",
          options: [
            "Converts Verilog to FPGA primitives (LUTs, FFs, etc.)",
            "Places components on the chip",
            "Generates the .bit file",
            "Programs the FPGA",
          ],
          a: 0,
        },
        {
          id: 57,
          category: "Section E: FPGA Implementation",
          q: "What does implementation do?",
          options: [
            "Converts Verilog to primitives",
            "Places primitives and routes wires between them",
            "Generates the .bit file",
            "Simulates the design",
          ],
          a: 1,
        },
        {
          id: 58,
          category: "Section E: FPGA Implementation",
          q: "The button btnU (top button) is connected to:",
          options: ["write_en", "save_data", "rst (reset)", "show_reg"],
          a: 2,
        },
        {
          id: 59,
          category: "Section E: FPGA Implementation",
          q: "The button btnR (right button) is connected to:",
          options: ["write_en", "save_data", "rst", "show_reg"],
          a: 1,
        },
        {
          id: 60,
          category: "Section E: FPGA Implementation",
          q: "The button btnL (left button) is connected to:",
          options: ["write_en", "save_data", "rst", "show_reg"],
          a: 3,
        },

        // Section F: Code Analysis (15 questions)
        {
          id: 61,
          category: "Section F: Code Analysis",
          q: "What is WRONG with this code?",
          code: "Lab2_mem U1 (\n    .a(d_in[5:0]),\n    .d(d_in), // <-- This line\n    .clk(clk),\n    .we(write_en),\n    .spo(mem_d)\n);",
          options: [
            "Nothing, it's correct",
            "Should be .d(reg_d) to allow staging",
            "Should be .d(mem_d)",
            "Should be .d(d_out)",
          ],
          a: 1,
        },
        {
          id: 62,
          category: "Section F: Code Analysis",
          q: "What is WRONG with this code?",
          code: "Lab2_top U1 (\n    .clk(clk), // <-- This line (in Lab2_imp.v)\n    .rst(rst),\n    ...\n);",
          options: [
            "Nothing, it's correct",
            "Should use sClk (slow clock) for human interaction",
            "Should use an external clock",
            "Should not have a clock",
          ],
          a: 1,
        },
        {
          id: 63,
          category: "Section F: Code Analysis",
          q: "What does this code do?",
          code: "always @(posedge clk) begin\n    if (rst)\n        reg_d <= 8'b0;\n    else if (save_data)\n        reg_d <= d_in;\nend",
          options: [
            "Asynchronous register with reset",
            "Synchronous register with reset and enable",
            "Combinational logic",
            "Memory controller",
          ],
          a: 1,
        },
        {
          id: 64,
          category: "Section F: Code Analysis",
          q: "What is the output of this expression when show_reg=1?",
          code: "assign d_out = show_reg ? mem_d : reg_d;",
          options: ["reg_d", "mem_d", "d_in", "0"],
          a: 1,
        },
        {
          id: 65,
          category: "Section F: Code Analysis",
          q: "What type of assignment is this?",
          code: "assign d_out = show_reg ? mem_d : reg_d;",
          options: [
            "Blocking assignment",
            "Non-blocking assignment",
            "Continuous assignment (ternary operator)",
            "Procedural assignment",
          ],
          a: 2,
        },
        {
          id: 66,
          category: "Section F: Code Analysis",
          q: "In this instantiation, what does .a(d_in[5:0]) mean?",
          code: "Lab2_mem U1 (\n    .a(d_in[5:0]),\n    ...\n);",
          options: [
            "Port 'a' connects to bits [5:0] of d_in",
            "Port 'a' is 5 bits wide",
            "d_in is shifted by 5",
            "Only bit 5 is connected",
          ],
          a: 0,
        },
        {
          id: 67,
          category: "Section F: Code Analysis",
          q: "What is the issue with this testbench code?",
          code: "initial begin\n    #10 d_in = 8'h15;\n    #10 save_data = 1;\n    #10 save_data = 0; d_in = 8'h01;\n    #10 write_en = 1;\nend",
          options: [
            "Nothing, it's correct",
            "Missing clock initialization",
            "Missing reset de-assertion",
            "Both B and C",
          ],
          a: 3,
        },
        {
          id: 68,
          category: "Section F: Code Analysis",
          q: "How many bits is this signal?",
          code: "wire [7:0] mem_d;",
          options: ["7 bits", "8 bits", "9 bits", "1 bit"],
          a: 1,
        },
        {
          id: 69,
          category: "Section F: Code Analysis",
          q: "This XDC constraint does what?",
          code: "set_property PACKAGE_PIN V17 [get_ports {d_in[0]}]",
          options: [
            "Sets d_in[0] to pin V17",
            "Maps physical pin V17 to signal d_in[0]",
            "Creates a new port",
            "Sets the voltage to 17V",
          ],
          a: 1,
        },
        {
          id: 70,
          category: "Section F: Code Analysis",
          q: "What synthesizes from this code?",
          code: "reg [27:0] counter;\nalways @(posedge clk_in)\n    counter <= counter + 1;",
          options: [
            "A 28-bit adder",
            "A 28-bit counter (28 flip-flops + increment logic)",
            "A 28-bit register",
            "A clock multiplier",
          ],
          a: 1,
        },
        {
          id: 71,
          category: "Section F: Code Analysis",
          q: "What is the difference between these two?",
          code: "// Version A\nalways @(posedge clk)\n    if (rst) reg_d <= 0;\n\n// Version B\nalways @(posedge clk or posedge rst)\n    if (rst) reg_d <= 0;",
          options: [
            "No difference",
            "A is synchronous reset, B is asynchronous reset",
            "B is synchronous reset, A is asynchronous reset",
            "Both are asynchronous",
          ],
          a: 1,
        },
        {
          id: 72,
          category: "Section F: Code Analysis",
          q: "What infers a flip-flop in Verilog?",
          options: [
            "always @(*)",
            "always @(posedge clk)",
            "assign statement",
            "wire declaration",
          ],
          a: 1,
        },
        {
          id: 73,
          category: "Section F: Code Analysis",
          q: "What infers combinational logic in Verilog?",
          options: [
            "always @(*) or assign",
            "always @(posedge clk)",
            "reg declaration",
            "Only assign statements",
          ],
          a: 0,
        },
        {
          id: 74,
          category: "Section F: Code Analysis",
          q: "In the seven_seg module, why are outputs active-low?",
          options: [
            "It's a Verilog requirement",
            "The Basys 3 uses common-anode 7-segment displays",
            "It's faster",
            "To save power",
          ],
          a: 1,
        },
        {
          id: 75,
          category: "Section F: Code Analysis",
          q: "What does this generate?",
          code: "always #5 clk = ~clk;",
          options: [
            "A 5 Hz clock",
            "A 10 Hz clock",
            "A clock that toggles every 5 time units (10 time unit period)",
            "A one-time pulse",
          ],
          a: 2,
        },

        // Section G: Conceptual Questions (10 questions)
        {
          id: 76,
          category: "Section G: Conceptual Questions",
          q: "The main advantage of simulation before hardware testing is:",
          options: [
            "It's faster",
            "Full visibility into all signals, repeatable tests, fast iteration",
            "It's required by Vivado",
            "Hardware doesn't work without it",
          ],
          a: 1,
        },
        {
          id: 77,
          category: "Section G: Conceptual Questions",
          q: "Time-multiplexing means:",
          options: [
            "Using multiple clocks",
            "Sharing resources across time (same switches for data and address)",
            "Running operations in parallel",
            "Dividing the clock frequency",
          ],
          a: 1,
        },
        {
          id: 78,
          category: "Section G: Conceptual Questions",
          q: "The load-store architecture pattern means:",
          options: [
            "Data moves through registers before reaching memory",
            "Memory has both load and store ports",
            "Registers are faster than memory",
            "All operations use memory",
          ],
          a: 0,
        },
        {
          id: 79,
          category: "Section G: Conceptual Questions",
          q: "What is the industry practice for simulation vs. hardware testing?",
          options: [
            "50% simulation, 50% hardware",
            "20% simulation, 80% hardware",
            "80% simulation, 20% hardware",
            "No simulation needed",
          ],
          a: 2,
        },
        {
          id: 80,
          category: "Section G: Conceptual Questions",
          q: "Synchronous operations are preferred for:",
          options: [
            "Fast responses",
            "State changes (writes, register updates) to avoid glitches",
            "Reading data",
            "Combinational logic",
          ],
          a: 1,
        },
        {
          id: 81,
          category: "Section G: Conceptual Questions",
          q: "Asynchronous operations are preferred for:",
          options: [
            "Writing data",
            "State changes",
            "Reads/lookups when you need immediate response",
            "Reset signals",
          ],
          a: 2,
        },
        {
          id: 82,
          category: "Section G: Conceptual Questions",
          q: "Why is modular design important (Lab2_top separate from Lab2_imp)?",
          options: [
            "Easier to test and debug",
            "Core logic is portable and reusable",
            "Separates board-specific code from design logic",
            "All of the above",
          ],
          a: 3,
        },
        {
          id: 83,
          category: "Section G: Conceptual Questions",
          q: "What real-world system uses address/data bus multiplexing?",
          options: [
            "CPUs and DDR memory",
            "USB cables",
            "Power supplies",
            "Keyboards",
          ],
          a: 0,
        },
        {
          id: 84,
          category: "Section G: Conceptual Questions",
          q: "The staging register pattern is used in:",
          options: [
            "CPU register files",
            "Pipeline stages",
            "FIFO buffers",
            "All of the above",
          ],
          a: 3,
        },
        {
          id: 85,
          category: "Section G: Conceptual Questions",
          q: "Why don't we initialize the distributed RAM?",
          options: [
            "Distributed RAM typically doesn't support initialization",
            "We want random data",
            "Block RAM is better for initialization",
            "Both A and C",
          ],
          a: 3,
        },

        // Section H: Common Mistakes & Debugging (10 questions)
        {
          id: 86,
          category: "Section H: Common Mistakes & Debugging",
          q: "If the display always shows 0, the most likely cause is:",
          options: [
            "Wrong MUX connection",
            "Still in reset (rst not released)",
            "Wrong clock",
            "Bad memory",
          ],
          a: 1,
        },
        {
          id: 87,
          category: "Section H: Common Mistakes & Debugging",
          q: "If button presses don't work on the FPGA, you should:",
          options: [
            "Press faster",
            "Hold the button until LED[7] blinks",
            "Reset the board",
            "Regenerate the bitstream",
          ],
          a: 1,
        },
        {
          id: 88,
          category: "Section H: Common Mistakes & Debugging",
          q: "If d_out is always 'X' in simulation, check:",
          options: [
            "Clock initialization",
            "RAM instantiation (spo connected to mem_d?)",
            "Testbench syntax",
            "FPGA programming",
          ],
          a: 1,
        },
        {
          id: 89,
          category: "Section H: Common Mistakes & Debugging",
          q: "If synthesis uses Block RAM instead of distributed RAM:",
          options: [
            "Change the data width",
            "Regenerate IP with 'Distributed Memory Generator'",
            "Use a different FPGA",
            "Modify the constraints",
          ],
          a: 1,
        },
        {
          id: 90,
          category: "Section H: Common Mistakes & Debugging",
          q: "Why must you keep the simulator open after Task 2?",
          options: [
            "To save memory",
            "Lab supervisor needs to verify your Task 2 work during assessment",
            "It keeps the license active",
            "The FPGA won't work otherwise",
          ],
          a: 1,
        },
        {
          id: 91,
          category: "Section H: Common Mistakes & Debugging",
          q: "If switches don't control anything on hardware:",
          options: [
            "Check XDC pin mappings",
            "Check if bitstream was loaded",
            "Check if constraints were applied",
            "All of the above",
          ],
          a: 3,
        },
        {
          id: 92,
          category: "Section H: Common Mistakes & Debugging",
          q: "If the testbench output is wrong, you should:",
          options: [
            "Reprogram the FPGA",
            "View internal signals (reg_d, mem_d) in waveform to debug",
            "Change the test sequence",
            "Skip simulation",
          ],
          a: 1,
        },
        {
          id: 93,
          category: "Section H: Common Mistakes & Debugging",
          q: "The most common mistake in Lab2_top.v is:",
          options: [
            "Wrong clock frequency",
            "Connecting RAM data input to d_in instead of reg_d",
            "Missing the MUX",
            "Wrong timescale",
          ],
          a: 1,
        },
        {
          id: 94,
          category: "Section H: Common Mistakes & Debugging",
          q: "The most common mistake in Lab2_imp.v is:",
          options: [
            "Wrong instance name",
            "Using 100MHz clock instead of sClk",
            "Missing modules",
            "Wrong port order",
          ],
          a: 1,
        },
        {
          id: 95,
          category: "Section H: Common Mistakes & Debugging",
          q: "If memory writes don't persist:",
          options: [
            "Check that write_en is pulsed during a clock edge",
            "Check that reg_d has the correct data",
            "Check show_reg isn't stuck at 0 when trying to view memory",
            "All of the above",
          ],
          a: 3,
        },

        // Section I: Synthesis Reports (5 questions)
        {
          id: 96,
          category: "Section I: Synthesis Reports",
          q: "After synthesis of Lab2_top, you should see:",
          options: [
            "Only combinational logic",
            "8 LUT-RAMs, 8 flip-flops, and ~8 LUTs for the MUX",
            "Block RAM",
            "No resources used",
          ],
          a: 1,
        },
        {
          id: 97,
          category: "Section I: Synthesis Reports",
          q: "The 8 flip-flops inferred are for:",
          options: [
            "The memory",
            "The register (reg_d)",
            "The clock divider",
            "The MUX",
          ],
          a: 1,
        },
        {
          id: 98,
          category: "Section I: Synthesis Reports",
          q: "The LUT-RAMs (RAMD64E) are:",
          options: [
            "The distributed memory",
            "The register",
            "The MUX",
            "The clock divider",
          ],
          a: 0,
        },
        {
          id: 99,
          category: "Section I: Synthesis Reports",
          q: "What should the implementation stage have?",
          options: [
            "Many warnings",
            "Zero warnings (if done correctly)",
            "Errors are acceptable",
            "Critical warnings only",
          ],
          a: 1,
        },
        {
          id: 100,
          category: "Section I: Synthesis Reports",
          q: "Where is the distributed memory physically located?",
          options: [
            "In dedicated Block RAM",
            "Inside LUTs (same resources used for logic)",
            "In external DRAM",
            "In a separate memory chip",
          ],
          a: 1,
        },
      ];

      let currentQuestions = [];
      let currentIndex = 0;
      let score = 0;
      let hasAnswered = false;
      let userAnswers = []; // Track user's answers for review

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        const quizScreen = document.getElementById("quiz-screen");
        if (quizScreen.classList.contains("hidden")) return;

        // Press 1-4 for options A-D
        if (!hasAnswered && e.key >= "1" && e.key <= "4") {
          const optionIndex = parseInt(e.key) - 1;
          const buttons = document.querySelectorAll(".option-btn");
          if (buttons[optionIndex]) {
            selectOption(optionIndex, buttons[optionIndex]);
          }
        }

        // Enter or Space for next question
        if (hasAnswered && (e.key === "Enter" || e.key === " ")) {
          e.preventDefault();
          window.nextQuestion();
        }
      });

      // Expose to window for inline onclicks
      window.startQuiz = (mode) => {
        if (mode === "all") {
          currentQuestions = [...quizData].sort(() => Math.random() - 0.5);
        } else {
          currentQuestions = quizData
            .filter((q) => q.category === mode)
            .sort(() => Math.random() - 0.5);
        }
        currentIndex = 0;
        score = 0;
        userAnswers = [];
        document.getElementById("setup-screen").classList.add("hidden");
        document.getElementById("quiz-screen").classList.remove("hidden");
        showQuestion();
      };

      window.showCategorySelector = () => {
        const list = document.getElementById("category-buttons");
        list.innerHTML = "";
        const categories = [...new Set(quizData.map((q) => q.category))];
        categories.forEach((cat) => {
          const btn = document.createElement("button");
          btn.className =
            "p-2 text-left text-sm border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors truncate";
          btn.innerText = cat;
          btn.onclick = () => window.startQuiz(cat);
          list.appendChild(btn);
        });
        document.getElementById("category-list").classList.toggle("hidden");
      };

      function showQuestion() {
        const q = currentQuestions[currentIndex];
        hasAnswered = false;
        document.getElementById("category-label").innerText = q.category;
        document.getElementById("progress-text").innerText =
          `Question ${currentIndex + 1} of ${currentQuestions.length}`;
        document.getElementById("progress-bar").style.width =
          `${((currentIndex + 1) / currentQuestions.length) * 100}%`;
        document.getElementById("question-text").innerText = q.q;

        const codeEl = document.getElementById("code-block");
        if (q.code) {
          codeEl.innerText = q.code;
          codeEl.classList.remove("hidden");
        } else {
          codeEl.classList.add("hidden");
        }

        const container = document.getElementById("options-container");
        container.innerHTML = "";
        q.options.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.className =
            "option-btn w-full p-4 text-left rounded-xl border-2 border-slate-100 hover:border-indigo-300 font-medium text-slate-700 flex items-center transition-all";
          btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold mr-4 shrink-0">${String.fromCharCode(65 + idx)}</span><span>${opt}</span>`;
          btn.onclick = () => selectOption(idx, btn);
          btn.setAttribute("data-option-index", idx);
          container.appendChild(btn);
        });
        document.getElementById("next-btn").disabled = true;
      }

      function selectOption(idx, btn) {
        if (hasAnswered) return;
        hasAnswered = true;
        const q = currentQuestions[currentIndex];
        const isCorrect = idx === q.a;

        // Track user's answer
        userAnswers.push({
          question: q.q,
          userAnswer: idx,
          correctAnswer: q.a,
          isCorrect: isCorrect,
          options: q.options,
        });

        if (isCorrect) {
          score++;
          btn.classList.add("border-emerald-500", "bg-emerald-50");
        } else {
          btn.classList.add("border-rose-500", "bg-rose-50");
        }
        const buttons = document.querySelectorAll(".option-btn");
        buttons.forEach((b) => (b.disabled = true));
        buttons[q.a].classList.add("border-emerald-500", "bg-emerald-100");
        document.getElementById("next-btn").disabled = false;
        document.getElementById("next-btn").focus();
      }

      window.nextQuestion = () => {
        currentIndex++;
        if (currentIndex < currentQuestions.length) showQuestion();
        else showResults();
      };

      function showResults() {
        document.getElementById("quiz-screen").classList.add("hidden");
        document.getElementById("results-screen").classList.remove("hidden");

        const percentage = Math.round((score / currentQuestions.length) * 100);
        document.getElementById("final-score").innerText =
          `${score}/${currentQuestions.length}`;
        document.getElementById("final-percent").innerText = `${percentage}%`;

        // Dynamic feedback based on performance
        let feedback = "";
        let feedbackClass = "";
        if (percentage >= 95) {
          feedback = "üèÜ Perfect! You're absolutely lab-ready!";
          feedbackClass = "text-yellow-600";
        } else if (percentage >= 90) {
          feedback = "‚≠ê Excellent! You have mastery over the concepts.";
          feedbackClass = "text-emerald-600";
        } else if (percentage >= 80) {
          feedback = "‚ú® Great job! You're well-prepared for the lab.";
          feedbackClass = "text-green-600";
        } else if (percentage >= 70) {
          feedback = "üëç Good effort! Review weak areas and you'll be ready.";
          feedbackClass = "text-blue-600";
        } else if (percentage >= 60) {
          feedback = "üìö Decent start. More practice needed on key concepts.";
          feedbackClass = "text-amber-600";
        } else {
          feedback = "üìñ Keep studying! Review the README and try again.";
          feedbackClass = "text-orange-600";
        }

        document.getElementById("result-meta").innerHTML =
          `<span class="${feedbackClass} font-semibold">${feedback}</span>`;

        // Update submit form based on sign-in status
        const submitForm = document.getElementById("submit-form");
        if (user) {
          // User is signed in - show nickname input and submit button
          const defaultName = user.displayName || user.email.split("@")[0];
          submitForm.innerHTML = `
            <h3 class="font-bold text-indigo-900 mb-2">Save to Leaderboard?</h3>
            <p class="text-sm text-indigo-700 mb-3">Signed in as ${user.email}</p>
            <input
              type="text"
              id="username"
              maxlength="15"
              value="${defaultName}"
              placeholder="Display Name"
              class="w-full px-4 py-3 rounded-xl border border-indigo-200 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <button
              id="submit-score-btn"
              onclick="saveScore()"
              class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-all flex items-center justify-center"
            >
              <span id="btn-text">Submit Score</span>
              <div
                id="btn-loader"
                class="hidden loader w-5 h-5 border-2 border-white rounded-full ml-2"
              ></div>
            </button>
          `;
        } else {
          // User not signed in - show sign-in button
          submitForm.innerHTML = `
            <h3 class="font-bold text-indigo-900 mb-3">Sign in to save your score!</h3>
            <button
              onclick="signInWithGoogle()"
              class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white border-2 border-indigo-300 rounded-xl hover:bg-indigo-50 transition-all text-sm font-semibold text-slate-700"
            >
              <svg class="w-5 h-5" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Sign in with Google
            </button>
            <p class="text-xs text-indigo-600 mt-3">You can still practice without signing in!</p>
          `;
        }
      }

      // Security: Input validation and sanitization
      function sanitizeUsername(name) {
        // Remove harmful characters, limit length
        return name
          .replace(/[<>\"'&]/g, "")
          .trim()
          .substring(0, 15);
      }

      function validateScore(score, total) {
        return (
          Number.isInteger(score) &&
          Number.isInteger(total) &&
          score >= 0 &&
          score <= total &&
          total <= 100
        );
      }

      // Rate limiting: prevent spam submissions
      let lastSubmitTime = 0;
      const SUBMIT_COOLDOWN = 5000; // 5 seconds

      window.saveScore = async () => {
        if (!user) {
          alert("Please sign in with Google first!");
          await signInWithGoogle();
          return;
        }

        const nameInput = document.getElementById("username")?.value;
        const name = nameInput
          ? sanitizeUsername(nameInput)
          : user.displayName || user.email.split("@")[0];

        if (!name || name.length < 2) {
          alert("Please enter a valid display name (2-15 characters)");
          return;
        }

        // Rate limiting check
        const now = Date.now();
        if (now - lastSubmitTime < SUBMIT_COOLDOWN) {
          alert(
            `Please wait ${Math.ceil((SUBMIT_COOLDOWN - (now - lastSubmitTime)) / 1000)} seconds before submitting again.`,
          );
          return;
        }

        // Validate score data
        if (!validateScore(score, currentQuestions.length)) {
          console.error("Invalid score data");
          alert("Invalid score data. Please try again.");
          return;
        }

        const btnText = document.getElementById("btn-text");
        const btnLoader = document.getElementById("btn-loader");
        const submitBtn = document.getElementById("submit-score-btn");

        btnText.innerText = "Saving...";
        btnLoader.classList.remove("hidden");
        submitBtn.disabled = true;

        try {
          const scoreCollection = collection(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "leaderboard",
          );

          await addDoc(scoreCollection, {
            username: name,
            email: user.email,
            photoURL: user.photoURL || "",
            score: score,
            total: currentQuestions.length,
            timestamp: now,
            userId: user.uid,
            version: "2.0",
          });

          lastSubmitTime = now;
          showLeaderboardOnly();
        } catch (e) {
          console.error("Save error:", e);
          let errorMsg = "Could not save score. ";
          if (e.code === "permission-denied") {
            errorMsg +=
              "Make sure Google Sign-In is enabled in Firebase Console.";
          } else if (e.code === "unavailable") {
            errorMsg += "Network connection issue.";
          } else {
            errorMsg += "Please try again.";
          }
          alert(errorMsg);
        } finally {
          btnText.innerText = "Submit Score";
          btnLoader.classList.add("hidden");
          submitBtn.disabled = false;
        }
      };

      window.showLeaderboardOnly = async () => {
        document.getElementById("setup-screen").classList.add("hidden");
        document.getElementById("results-screen").classList.add("hidden");
        document
          .getElementById("leaderboard-screen")
          .classList.remove("hidden");

        const tbody = document.getElementById("leaderboard-body");
        const loader = document.getElementById("leaderboard-loading");
        tbody.innerHTML = "";
        loader.classList.remove("hidden");

        if (!user || !db) {
          loader.innerHTML =
            '<p class="text-amber-600 p-8 text-center">Leaderboard unavailable. Check your connection.</p>';
          return;
        }

        try {
          const scoreCol = collection(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "leaderboard",
          );
          const snapshot = await getDocs(query(scoreCol));
          let data = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Filter: Keep only best score per user
          const userBestScores = {};
          data.forEach((item) => {
            const percentage = item.score / item.total;
            const userId = item.userId || item.username; // fallback to username for grouping

            if (
              !userBestScores[userId] ||
              percentage > userBestScores[userId].percentage
            ) {
              userBestScores[userId] = {
                ...item,
                percentage: percentage,
              };
            }
          });

          // Convert back to array and sort by percentage (descending)
          data = Object.values(userBestScores).sort(
            (a, b) => b.percentage - a.percentage,
          );

          loader.classList.add("hidden");

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="3" class="p-8 text-center text-slate-400">No scores yet. Be the first!</td></tr>';
            return;
          }

          data.slice(0, 20).forEach((item, i) => {
            const row = document.createElement("tr");
            const percentage = Math.round(item.percentage * 100);

            // Medal colors for top 3
            const rankColor =
              i === 0
                ? "text-yellow-500"
                : i === 1
                  ? "text-slate-400"
                  : i === 2
                    ? "text-amber-600"
                    : "text-slate-300";

            const isMe = user && item.userId === user.uid;
            const rowClass = isMe ? "bg-indigo-50 font-semibold" : "";

            // Escape username for display safety
            const safeUsername = sanitizeUsername(item.username || "Anonymous");

            // Show profile photo if available
            const photoHTML = item.photoURL
              ? `<img src="${item.photoURL}" class="w-8 h-8 rounded-full inline-block mr-2" alt="${safeUsername}">`
              : "";

            row.className = rowClass;
            row.innerHTML = `
              <td class="px-6 py-4 font-bold ${rankColor}">#${i + 1}</td>
              <td class="px-6 py-4 text-slate-700">
                <div class="flex items-center gap-2">
                  ${photoHTML}
                  <span>${safeUsername}${isMe ? ' <span class="text-indigo-600">(You)</span>' : ""}</span>
                </div>
              </td>
              <td class="px-6 py-4 text-right font-mono font-bold text-indigo-600">${percentage}% <span class="text-xs text-slate-400">(${item.score}/${item.total})</span></td>
            `;
            tbody.appendChild(row);
          });
        } catch (e) {
          console.error("Load error:", e);
          loader.innerHTML =
            '<p class="text-rose-500 p-8 text-center">‚ö†Ô∏è Error loading leaderboard. Please refresh and try again.</p>';
        }
      };

      window.exitQuiz = () => location.reload();
    </script>
  </body>
</html>
